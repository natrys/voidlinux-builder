# Template file for 'factor'
pkgname=factor
version=20210329
revision=1
_commit=a4aaac4f4c293fcd08b5ef35821fe88fd370597a
wrksrc=${pkgname}-${_commit}
archs="i686 x86_64"
build_style=gnu-makefile
hostmakedepends="unzip pkg-config wget"
makedepends="gtk+-devel gtkglext-devel"
depends="gtk+-devel gtkglext-devel"
nostrip_files="a.elf"
short_desc="Concatenative programming language, similar to Forth"
maintainer="Imran Khan <imrankhan@teknik.io>"
license="BSD-2-Clause"
homepage="http://factorcode.org/"
distfiles="https://github.com/factor/factor/archive/${_commit}.tar.gz"
checksum=4775f9d085d8f59f80d7d439e9ee397af1c47b18e34ad39353f9169ddaf8f86d

post_build() {
	wget https://downloads.factorcode.org/images/master/boot.unix-x86.64.image
	image=''

	case "${XBPS_TARGET_MACHINE}" in
		i686*)   image='boot.unix-x86.32.image'
		         sse_version=0;;
		x86_64*) image='boot.unix-x86.64.image'
		         sse_version=20;;
		*) return 1;;
	esac

	touch /etc/ld.so.cache
	./factor -i="${image}" -sse-version="${sse_version}"
}

do_install() {
	vmkdir "usr/lib/${pkgname}"
	vcopy misc  "usr/lib/${pkgname}"
	vcopy extra "usr/lib/${pkgname}"
	vcopy core  "usr/lib/${pkgname}"
	vcopy basis "usr/lib/${pkgname}"

	vinstall factor       755 "usr/lib/${pkgname}"
	vinstall factor.image 644 "usr/lib/${pkgname}"

	vmkdir usr/bin
	ln -sr "${DESTDIR}/usr/lib/${pkgname}/factor" \
	       "${DESTDIR}/usr/bin/factor-vm"

	vlicense LICENSE.txt
}
